#!/bin/bash
# Скрипт обновления Portainer Agent + системных пакетов
# Автор: Никита
# Дата: $(date +"%Y-%m-%d")

set -e  # Завершать выполнение при ошибке

echo "=== Обновление списка пакетов APT ==="
sudo apt update -y

echo "=== Обновление установленных пакетов ==="
sudo apt upgrade -y

echo "=== Остановка контейнера Portainer Agent ==="
docker stop portainer_agent 2>/dev/null || echo "Контейнер portainer_agent не запущен"

echo "=== Удаление контейнера Portainer Agent ==="
docker rm portainer_agent 2>/dev/null || echo "Контейнер portainer_agent не найден"

echo "=== Загрузка последней версии образа Portainer Agent (lts) ==="
docker pull portainer/agent:lts

echo "=== Запуск контейнера Portainer Agent с обновлённым образом ==="
docker run -d \
  -p 9001:9001 \
  --name portainer_agent \
  --restart=always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /var/lib/docker/volumes:/var/lib/docker/volumes \
  portainer/agent:lts

echo "=== Очистка неиспользуемых пакетов и образов Docker ==="
sudo apt autoremove -y
sudo docker system prune -f

echo "=== Обновление завершено успешно ==="
docker ps --filter "name=portainer_agent"
