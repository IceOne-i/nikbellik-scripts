#!/bin/bash
set -e  # Остановка при ошибке

# ------------------------------
# Проверка запуска от root
# ------------------------------
if [ "$(id -u)" -ne 0 ]; then
    echo "❌ Скрипт должен быть запущен от имени root!"
    exit 1
fi

# ------------------------------
# Общие функции логирования
# ------------------------------
log() {
    echo "➡ $1"
}

# ------------------------------
# Утилитарная установка пакета
# ------------------------------
install_package() {
    if dpkg -s "$1" &> /dev/null; then
        log "$1 уже установлен, пропускаем..."
    else
        log "Установка пакета: $1"
        apt-get install -y -qq "$1" >/dev/null 2>&1
    fi
}

# ------------------------------
# Настройка авто-обновления системы
# ------------------------------
CRON_FILE="/etc/cron.d/auto_update_system"

setup_auto_update() {
    if [ -f "$CRON_FILE" ]; then
        log "Авто-обновление уже настроено, пропускаем..."
    else
        log "Настройка ежедневного авто-обновления системы..."
        cat <<EOT > "$CRON_FILE"
# Ежедневное обновление системы и перезагрузка при необходимости
0 3 * * * root apt-get update -qq && apt-get upgrade -y && \
    if [ -f /var/run/reboot-required ]; then reboot; fi
EOT
        chmod 644 "$CRON_FILE"
        log "✅ Авто-обновление настроено (ежедневно в 03:00 МСК)"
    fi
}

remove_auto_update() {
    if [ -f "$CRON_FILE" ]; then
        log "Удаление авто-обновления системы..."
        rm -f "$CRON_FILE"
        log "✅ Авто-обновление отключено."
    else
        log "Задача авто-обновления не найдена, пропускаем..."
    fi
}
