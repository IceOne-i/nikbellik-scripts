#!/bin/bash
# common_utils.sh - —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ TeamSpeak –∏ Minecraft
set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# ------------------------------
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ—Ç root
# ------------------------------
if [ "$(id -u)" -ne 0 ]; then
    echo "‚ùå –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ root!"
    exit 1
fi

# ------------------------------
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# ------------------------------
log() {
    echo "‚û° $1"
}

# ------------------------------
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
# ------------------------------
install_package() {
    if dpkg -s "$1" &> /dev/null; then
        log "$1 —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º..."
    else
        log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞: $1"
        apt-get install -y -qq "$1" >/dev/null 2>&1
    fi
}

# ------------------------------
# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
# ------------------------------
show_upgrade_info() {
    PACKAGES=$(apt list --upgradable 2>/dev/null | awk -F/ 'NR>1 {print $1}')
    if [ -z "$PACKAGES" ]; then
        log "üìã –í—Å–µ –ø–∞–∫–µ—Ç—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã, –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω–µ—á–µ–≥–æ."
    else
        log "üìã –î–æ—Å—Ç—É–ø–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤:"
        echo "$PACKAGES" | awk '{print "  - " $1}'
    fi
}

# ------------------------------
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —Å–æ–±—Ä–∞—Ç—å –æ—Ç—á—ë—Ç
# ------------------------------
perform_upgrade() {
    log "–ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
    apt-get full-upgrade -y | tee /tmp/upgrade_log.txt >/dev/null 2>&1

    UPDATED=$(grep "Setting up" /tmp/upgrade_log.txt | awk '{print $3}')
    FAILED=$(grep -i "failed\|error" /tmp/upgrade_log.txt | awk '{print $NF}')

    echo "------------------------------------------------------------"
    echo "üìå –ò—Ç–æ–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:"
    if [ -n "$UPDATED" ]; then
        echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–∞–∫–µ—Ç—ã:"
        echo "$UPDATED" | awk '{print "  - " $1}'
    else
        echo "‚úÖ –ù–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤"
    fi
    if [ -n "$FAILED" ]; then
        echo "‚ùå –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:"
        echo "$FAILED" | awk '{print "  - " $1}'
    else
        echo "‚ùå –û—à–∏–±–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ—Ç"
    fi
    echo "------------------------------------------------------------"
}

# ------------------------------
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –∞–ø–≥—Ä–µ–π–¥ —Å–∏—Å—Ç–µ–º—ã (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
# ------------------------------
update_and_upgrade_system() {
    log "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."
    apt-get update -qq >/dev/null 2>&1
    show_upgrade_info
    perform_upgrade
}

# ------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ cron
# ------------------------------
CRON_FILE="/etc/cron.d/auto_update_system"
setup_auto_update() {
    if [ -f "$CRON_FILE" ]; then
        log "–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º..."
    else
        log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã..."
        cat <<EOT > "$CRON_FILE"
# –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
0 3 * * * root apt-get update -qq && apt-get upgrade -y && \
    if [ -f /var/run/reboot-required ]; then reboot; fi
EOT
        chmod 644 "$CRON_FILE"
        log "‚úÖ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00)"
    fi
}

remove_auto_update() {
    if [ -f "$CRON_FILE" ]; then
        log "–£–¥–∞–ª–µ–Ω–∏–µ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã..."
        rm -f "$CRON_FILE"
        log "‚úÖ –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ."
    else
        log "–ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º..."
    fi
}

# ------------------------------
# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
# ------------------------------
confirm_shutdown() {
    while true; do
        printf "\033[32;1müî¥ –•–æ—Ç–∏—Ç–µ –≤—ã–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–µ—Ä? (y/n)\033[0m\n"
        read -r shutdown_choice
        case "$shutdown_choice" in
            y|Y )
                log "–í—ã–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
                shutdown -h now
                break
                ;;
            n|N )
                log "–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∫–ª—é—á—ë–Ω–Ω—ã–º."
                break
                ;;
            * )
                echo "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ y –∏–ª–∏ n"
                ;;
        esac
    done
}
